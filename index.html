<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rewards Airdrop Mining</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://js.hcaptcha.com/1/api.js" async defer></script>
<style>
body { font-family: Arial, sans-serif; background:#0a0a0a; color:#e0e0e0; margin:0; text-align:center; }
#login-overlay {
  position: fixed; top:0; left:0; width:100%; height:100%;
  background: rgba(0,0,0,0.85);
  display:flex; align-items:center; justify-content:center; z-index:9999;
}
#login-box {
  background:#111; padding:25px; border-radius:12px; width:320px; max-width:90%; text-align:center; overflow:visible; 
  box-shadow: 0 0 20px #00ff99aa;
}
#login-box h2 { color:white; margin-bottom:15px; }
#login-box input {
  width:90%; padding:8px; margin:5px 0; border-radius:6px; border:none;
}
button {
  padding:10px 20px; margin:5px; border:none; border-radius:8px; cursor:pointer;
  background:#00ff99; color:#000; font-weight:bold; transition: transform 0.1s;
}
button:hover { transform: scale(1.05); }

#app { display:none; padding:20px; }
.energy-bar { width:100%; background:#333; border-radius:12px; overflow:hidden; margin:10px 0; }
.energy-fill { height:20px; background:lime; width:100%; transition:width 0.3s; animation:flash 2s infinite; }
@keyframes flash { 0%{opacity:1} 50%{opacity:0.6} 100%{opacity:1} }
#stats { margin:20px; text-align:left; display:inline-block; }
a { color:yellow; text-decoration:none; }
a:hover { text-decoration:underline; }
</style>
</head>
<body>

<!-- LOGIN / INSCRIPTION -->
<div id="login-overlay">
  <div id="login-box">
    <h2>Connexion</h2>
    <input type="email" id="email" placeholder="Email"><br>
    <input type="password" id="password" placeholder="Mot de passe"><br><br>

    <div class="h-captcha" 
         data-sitekey="ES_04ef5b9205754f168e57485a0893f1ad" 
         data-theme="dark" 
         data-size="compact">
    </div>
    <br>

    <button id="btnSignUp">S'inscrire</button>
    <button id="btnSignIn">Se connecter</button>
  </div>
</div>

<!-- APP -->
<div id="app">
  <h1>Rewards Airdrop Mining</h1>
  <div id="stats">
    <p><b>Deadspot:</b> <span id="deadspot">0</span></p>
    <p><b>XP:</b> <span id="xp">0</span></p>
    <p><b>Level:</b> <span id="level">1</span></p>
    <p><b>Énergie:</b> <span id="energy">1000</span> / <span id="energyMax">1000</span></p>
  </div>

  <div class="energy-bar"><div class="energy-fill" id="energy-fill"></div></div>

  <button id="clickBtn">CLICK to Earn</button>
  <br><br>
  <a href="cpu_simulator.html">Aller à la page Simulateur CPU</a>
</div>

<script>
// CONFIG SUPABASE
const SUPABASE_URL = "https://wbavwtwslofcrpeuyqak.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_Q_Jm1qse1MuBwINNgm7QuQ_sqQG-WfA";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// STATE INITIAL
let state = { deadspot:0, xp:0, level:1, energy:1000, energyMax:1000 };

// LOAD USER STATE
async function loadUserState() {
  const { data: { session } } = await supabaseClient.auth.getSession();
  if(!session) return;
  const userId = session.user.id;
  const { data } = await supabaseClient.from("user_state").select("*").eq("id", userId).single();
  if(data) state = data;
  updateUI();
}

// SAVE USER STATE
async function saveUserState() {
  const { data: { session } } = await supabaseClient.auth.getSession();
  if(!session) return;
  const userId = session.user.id;
  await supabaseClient.from("user_state").upsert({ id:userId, ...state });
}

// UPDATE UI
function updateUI(){
  document.getElementById("deadspot").innerText = state.deadspot.toFixed(4);
  document.getElementById("xp").innerText = state.xp.toFixed(2);
  document.getElementById("level").innerText = state.level;
  document.getElementById("energy").innerText = state.energy;
  document.getElementById("energyMax").innerText = state.energyMax;
  document.getElementById("energy-fill").style.width = (state.energy/state.energyMax*100)+"%";
}

// SIGN UP
document.getElementById("btnSignUp").onclick = async () => {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  // hCaptcha verification
  const captchaResponse = hcaptcha.getResponse();
  if(!captchaResponse) {
    alert("Veuillez valider le captcha");
    return;
  }

  const { error } = await supabaseClient.auth.signUp({ email, password });
  if(error) alert(error.message); else alert("Inscription réussie !");
}

// SIGN IN
document.getElementById("btnSignIn").onclick = async () => {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
  if(error) alert(error.message);
  else {
    document.getElementById("login-overlay").style.display="none";
    document.getElementById("app").style.display="block";
    await loadUserState();
  }
}

// CLICK TO EARN
document.getElementById("clickBtn").onclick = () => {
  if(state.energy <=0) return alert("Pas assez d'énergie");
  state.energy--;
  state.deadspot += 0.001 + Math.random()*0.27;
  state.xp += 0.175;
  if(state.xp > (15*Math.pow(1.27,state.level-1))) state.level++;
  updateUI(); saveUserState();
}

// AUTO LOGIN IF SESSION
window.addEventListener("load", async () => {
  const { data: { session } } = await supabaseClient.auth.getSession();
  if(session){
    document.getElementById("login-overlay").style.display="none";
    document.getElementById("app").style.display="block";
    await loadUserState();
  }
});
</script>
</body>
</html>
